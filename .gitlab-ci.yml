include:
  - template: Jobs/Build.gitlab-ci.yml # https://gitlab.com/gitlab-org/gitlab-foss/blob/master/lib/gitlab/ci/templates/Jobs/Build.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/License-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml

stages:
- generate
- build
- test-code
- test
- deploy

generate:
  image: gradle:alpine
  stage: generate
  script:
    - java -jar openapi-generator-cli-5.2.0.jar generate  -i spec/openapi.yaml -c open-api-conf.yaml -g typescript-axios -o ./src/generated
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: push
    paths:
      - src/generated

build:
  image: node:15-alpine
  stage: build
  script:
    - npm install
    - npm run build
  cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
      - node_modules
      - src/generated
      - lib

test:
  image: node:15-alpine
  stage: test-code
  script: 
    - npm run test
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - node_modules
      - src/generated
      - lib

deploy:
  image: node:15-alpine
  stage: deploy
  script:
    - echo "@ubiquity:registry=https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/">>.npmrc
    - echo "//gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}">>.npmrc
    - echo "always-auth=true">>.npmrc
    - npm publish
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - node_modules
      - src/generated
      - lib
  only:
  - tags
 
